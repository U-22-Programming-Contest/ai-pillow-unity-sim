# ai-pillow-unity-sim

## 目次

1. [概要](#概要)
2. [使用技術一覧](#使用技術一覧)
3. [システム設計について](#システム設計について)
4. [環境](#環境)
5. [ディレクトリ構成](#ディレクトリ構成)
6. [開発環境構築](#開発環境構築)
7. [開発者](#開発者)

## 概要
本プロジェクトは、枕に設置された4つの圧力センサーから時系列で記録されたCSVデータを読み込み、Unity上で頭部の動きと枕にかかる圧力分布を可視化するシミュレーションです。
CSVデータに基づき、頭部モデルの位置と姿勢を再現し、圧力の中心をヒートマップとして枕のテクスチャに動的に描画します。また、三人称視点のカメラが自動で動き、シミュレーションの様子を多角的に確認できます。


## 使用技術一覧
### 主要技術
- エンジン: Unity 2021.3.11f1
- 言語: C# (9.0)
- データ入力: CSVファイルによるセンサーデータ入力
- 可視化: C#によるプロシージャルテクスチャ生成（ヒートマップ可視化）

### 開発ツール
- IDE: Visual Studio 2022
- バージョン管理: Git、GitHub

### 使用ライブラリ
本プロジェクトでは、主にUnityに標準で組み込まれている以下のライブラリを使用しています。
- UnityEngine : Unityのコア機能全般（GameObject、Transform、コルーチンなど）
- System.IO : CSVファイルの読み込み (File, Path)
- System.Collections.Generic : List<> を使用したデータ格納


## システム設計について
本シミュレーションは、3つの主要スクリプトが連携して動作します。

### CSVReader.cs (データ処理とシミュレーション制御)
- 役割 : シミュレーション全体のコントローラー
- 動作 : 起動時に `StreamingAssets` フォルダから `sensor_data.csv` を読み込み、圧力と姿勢のデータをメモリに格納します。各データポイントの圧力値から頭部の重心位置を計算し、姿勢データから頭部の回転を決定します。MoveHead コルーチンを開始し、計算された位置と回転に沿って頭部オブジェクトを滑らかに動かします。頭部オブジェクトのワールド座標を枕のUV座標に変換し、`PillowHeatmapTexture` スクリプトに渡しています。

### PillowHeatmapTexture.cs (ヒートマップ描画)
- 役割 : 枕の表面に表示されるヒートマップテクスチャの生成と更新
- 動作 : `CSVReader` から圧力の中心となるUV座標を受け取ります。受け取ったUV座標を中心に、距離に応じた色のグラデーションを持つ Texture2D を動的に生成します。生成したテクスチャを枕オブジェクトのマテリアルのメインテクスチャとして適用し、見た目を更新します。

### CameraController.cs (カメラ制御)
- 役割 : シミュレーションを見やすくするためのカメラワークを提供。
- 動作 : シミュレーション開始時に、カメラをターゲット（枕）に対して正面からズームアップし上昇させます。上昇後は、ターゲットを中心に左右へ自動で往復回転し続け、ユーザーが操作しなくてもオブジェクト全体を俯瞰できる視点を維持します。

### 工夫した点・アピールポイント
本シミュレーションの開発において、よりリアルな可視化と実装の効率化のために以下の工夫を行いました。

#### 頭部モデルの回転軸の調整
頭部3Dモデルのデフォルトの回転軸が喉の中心にあり、そのまま回転させると不自然な動きになりました。これを解決するため、空の親オブジェクトを作成し、その子として頭部モデルを配置しました。回転はこの親オブジェクトに対して行うことで、後頭部を軸とした自然な寝返り動作を再現しています。

#### Blenderを使用した枕モデルの作成とマテリアル設定
枕の3DモデルはBlenderを使用して作成しました。枕の側面と上面でマテリアルを分け、側面部分のマテリアルを透明に設定しています。これにより、枕内部にある圧力センサーを視認できるようにしました。

#### ヒートマップ描画の最適化
複雑な枕モデルに直接ヒートマップを描画するとUV座標の計算が煩雑になり、パフォーマンスに影響を与える可能性があります。そこで、ヒートマップの描画専用に、枕と同じサイズのシンプルな平面オブジェクトを別途用意しました。計算はこの平面オブジェクトに対して行うことで、処理を簡略化し、安定した描画を実現しています。


## 環境
- Unity : 2021.3.x LTS (Long Term Support) バージョンでの開発を推奨します。
- OS : Windows 11, macOS


## ディレクトリ構成
本プロジェクトのディレクトリ構成は下記の通りです。
```
Assets/
├── Models/         # 3Dモデル (枕、頭)
├── Scenes/         # シーンファイル
├── Scripts/        # C#スクリプト
│   ├── CameraController.cs
│   ├── CSVReader.cs
│   └── PillowHeatmapTexture.cs
└── StreamingAssets/  # 外部データ
    └── sensor_data.csv
```


## 開発環境構築
### Unityプロジェクトの作成
Unity Hubから、3D Coreテンプレートを使用して新しいUnityプロジェクトを作成します。

### フォルダの作成
Assets フォルダ内に、上記の「ディレクトリ構成」で示したフォルダを作成します。

### アセットの配置
作成した `Scripts` フォルダに、提供された3つのC#スクリプトを配置します。
`StreamingAssets` フォルダに、シミュレーションに使用する sensor_data.csv を配置します。
枕と頭の3Dモデルを `Models` フォルダに配置します。

### シーンのセットアップ
#### 枕オブジェクトの作成
Hierarchy ウィンドウで右クリックし、3D Object > Plane を選択して枕オブジェクト (Pillow) を作成します。Pillow に `PillowHeatmapTexture.cs` をアタッチします。
インスペクターで以下を設定します。
- Pillow Renderer: Pillow オブジェクト自身の Mesh Renderer をドラッグ＆ドロップ。
- Pillow Transform: Pillow オブジェクト自身の Transform をドラッグ＆ドロップ。
- その他、Texture Size や Heat Radius を調整します。
#### 頭部オブジェクトの作成
Hierarchy ウィンドウで右クリックし、3D Object > Sphere またはインポートした頭部モデルを配置して Head を作成します。
#### コントローラーの作成
Hierarchy ウィンドウで右クリックし、Create Empty を選択して空のGameObjectを作成します。
SimulationManager に CSVReader.cs をアタッチします。
インスペクターで以下を設定します。
- Head Object : Head オブジェクトをドラッグ＆ドロップ。
- Pillow Heatmap : Pillow オブジェクトをドラッグ＆ドロップ。
- Plane Transform : Pillow オブジェクトの Transform をドラッグ＆ドロップ。
Sensor 1-4 Position : 枕のローカル座標系における各センサーの位置を Vector3 で指定します。（例: (0.2, 0, 0.1), (-0.2, 0, 0.1) など）
#### カメラの設定
シーン内の Main Camera に CameraController.cs をアタッチします。
インスペクターで以下を設定します。
- Target: Pillow オブジェクトの Transform をドラッグ＆ドロップ。
- その他、Distance や Rotation Speed などの値を好みに合わせて調整します。

### 実行
Unityエディタの上部にある再生ボタンを押して、シミュレーションを開始します。


## 開発者
大分工業高等専門学校情報工学科　首藤桃音
